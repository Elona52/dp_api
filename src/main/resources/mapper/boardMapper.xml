<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.api.board.mapper.BoardMapper">

    <resultMap id="findBoardMap" type="com.api.board.domain.FindBoard">
        <id property="no" column="no"/>
        <result property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="category" column="category"/>
        <result property="views" column="views"/>
        <result property="relatedLink" column="related_link"/>
        <result property="regDate" column="reg_date"/>
    </resultMap>

    <resultMap id="replyMap" type="com.api.board.domain.Reply">
        <id property="no" column="no"/>
        <result property="id" column="id"/>
        <result property="content" column="content"/>
        <result property="regDate" column="reg_date"/>
        <result property="boardNo" column="board_no"/>
    </resultMap>

    <!-- 게시글 등록 -->
    <insert id="insertBoard" parameterType="com.api.board.domain.FindBoard" useGeneratedKeys="true" keyProperty="no">
        INSERT INTO find_board (
            id,
            title,
            content,
            category,
            views,
            related_link,
            reg_date
        ) VALUES (
            #{id},
            #{title},
            #{content},
            #{category},
            0,
            #{relatedLink},
            CURRENT_TIMESTAMP
        )
    </insert>

    <!-- 게시글 목록 조회 (검색 조건 포함) -->
    <select id="getBoardList" resultMap="findBoardMap">
        SELECT 
            no,
            id,
            title,
            content,
            category,
            views,
            related_link,
            reg_date
        FROM find_board
        <where>
            <if test="id != null and id != ''">
                AND id = #{id}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (title LIKE CONCAT('%', #{keyword}, '%') 
                     OR content LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="category != null and category != '' and category != 'all'">
                AND category = #{category}
            </if>
        </where>
        ORDER BY no DESC
    </select>

    <!-- 게시글 상세 조회 -->
    <select id="getBoard" parameterType="int" resultMap="findBoardMap">
        SELECT 
            no,
            id,
            title,
            content,
            category,
            views,
            related_link,
            reg_date
        FROM find_board
        WHERE no = #{no}
    </select>

    <!-- 게시글 수정 -->
    <update id="updateBoard" parameterType="com.api.board.domain.FindBoard">
        UPDATE find_board
        <set>
            <if test="title != null and title != ''">
                title = #{title},
            </if>
            <if test="content != null and content != ''">
                content = #{content},
            </if>
            <if test="category != null and category != ''">
                category = #{category},
            </if>
            <if test="relatedLink != null">
                related_link = #{relatedLink},
            </if>
        </set>
        WHERE no = #{no}
    </update>

    <!-- 조회수 증가 -->
    <update id="incrementBoardViews" parameterType="int">
        UPDATE find_board
        SET views = views + 1
        WHERE no = #{no}
    </update>

    <!-- 게시글 삭제 -->
    <delete id="deleteBoard" parameterType="int">
        DELETE FROM find_board
        WHERE no = #{no}
    </delete>

    <!-- 댓글 등록 -->
    <insert id="insertReply" parameterType="com.api.board.domain.Reply" useGeneratedKeys="true" keyProperty="no">
        INSERT INTO reply (
            id,
            content,
            board_no,
            reg_date
        ) VALUES (
            #{id},
            #{content},
            #{boardNo},
            CURRENT_TIMESTAMP
        )
    </insert>

    <!-- 댓글 수정 -->
    <update id="updateReply" parameterType="com.api.board.domain.Reply">
        UPDATE reply
        SET content = #{content}
        WHERE no = #{no} AND board_no = #{boardNo}
    </update>

    <!-- 댓글 삭제 -->
    <delete id="deleteReply" parameterType="int">
        DELETE FROM reply
        WHERE no = #{no}
    </delete>

    <!-- 댓글 목록 조회 -->
    <select id="getReplyList" parameterType="int" resultMap="replyMap">
        SELECT 
            no,
            id,
            content,
            reg_date,
            board_no
        FROM reply
        WHERE board_no = #{boardNo}
        ORDER BY reg_date ASC
    </select>

    <!-- 경매 건수 조회 (사용하지 않을 수도 있음) -->
    <select id="getAuctionCount" resultType="int">
        SELECT COUNT(*) 
        FROM find_board
        <where>
            <if test="period != null and period != ''">
                AND reg_date >= DATE_SUB(NOW(), INTERVAL #{period} DAY)
            </if>
            <if test="keyword != null and keyword != ''">
                AND (title LIKE CONCAT('%', #{keyword}, '%') 
                     OR content LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
    </select>

</mapper>

