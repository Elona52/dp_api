<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>경매물건 상세정보</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
    
    <!-- Leaflet 지도 API -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Auction CSS -->
    <link rel="stylesheet" th:href="@{/css/auction.css}">
    <link rel="stylesheet" th:href="@{/css/kamco.css}">
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <style>
        :root {
            --court-blue: #004098;
            --court-navy: #002855;
            --court-green: #52b788;
            --court-red: #d32f2f;
            --border-gray: #ddd;
            --bg-light: #f5f5f5;
            --text-dark: #333;
            --text-gray: #777;
        }
        
        * {
            box-sizing: border-box;
        }
        
        html, body {
            font-family: 'Nanum Gothic', 'Malgun Gothic', sans-serif;
            margin: 0;
            padding: 0;
            width: 100%;
            background: #f5f5f5;
        }
        
        /* 상세 페이지 컨테이너 */
        .detail-page-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px 40px;
            background: #f5f5f5;
        }
        
        /* 상단 헤더 영역 */
        .detail-header {
            background: #fff;
            border: 1px solid var(--border-gray);
            padding: 20px 30px;
            margin-bottom: 20px;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .breadcrumb {
            font-size: 13px;
            color: var(--text-gray);
        }
        
        .breadcrumb a {
            color: var(--text-gray);
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            color: var(--court-blue);
        }
        
        .share-buttons {
            display: flex;
            gap: 10px;
        }
        
        .share-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border-gray);
            background: #fff;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-gray);
            text-decoration: none;
        }
        
        .share-btn:hover {
            background: #f8f9fa;
            color: var(--court-blue);
        }
        
        .header-info {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-gray);
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .info-label {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .info-value {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-batch {
            padding: 10px 20px;
            background: var(--court-blue);
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
        }
        
        .notice-box {
            background: #fffbf0;
            border: 1px solid #ffe082;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .notice-text {
            font-size: 13px;
            color: #795548;
            flex: 1;
        }
        
        .btn-notice {
            padding: 6px 15px;
            background: #fff;
            border: 1px solid #ffe082;
            border-radius: 4px;
            font-size: 12px;
            color: #795548;
            cursor: pointer;
        }
        
        /* 메인 컨텐츠 영역 */
        .detail-main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* 왼쪽: 이미지/지도 영역 */
        .detail-left {
            background: #fff;
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .item-title-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-gray);
        }
        
        .item-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 10px;
        }
        
        .item-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .item-tag {
            padding: 4px 10px;
            background: #f5f5f5;
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-dark);
        }
        
        .image-map-container {
            position: relative;
            width: 100%;
            height: 500px;
            background: #f8f9fa;
        }
        
        .image-map-container img,
        .image-map-container #map {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .map-controls button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .map-controls button:hover {
            background: #f8f9fa;
            border-color: var(--court-blue);
            color: var(--court-blue);
        }
        
        .image-controls {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            border-top: 1px solid var(--border-gray);
            background: #fff;
        }
        
        .image-control-btn {
            padding: 8px 15px;
            background: #fff;
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            color: var(--text-dark);
            text-decoration: none;
        }
        
        .image-control-btn:hover {
            background: #f8f9fa;
            color: var(--court-blue);
        }
        
        /* 오른쪽: 상세 정보 */
        .detail-right {
            background: #fff;
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            padding: 25px;
        }
        
        .detail-info-table {
            width: 100%;
        }
        
        .detail-info-row {
            display: grid;
            grid-template-columns: 140px 1fr;
            padding: 12px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .detail-info-row:last-child {
            border-bottom: none;
        }
        
        .detail-info-label {
            font-size: 14px;
            color: var(--text-gray);
            font-weight: 600;
        }
        
        .detail-info-value {
            font-size: 14px;
            color: var(--text-dark);
        }
        
        .detail-info-value.price {
            font-size: 20px;
            font-weight: 700;
            color: var(--court-red);
        }
        
        .bidding-types {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .bidding-type-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bidding-type-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .detail-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .detail-action-btn {
            padding: 12px;
            border: 1px solid var(--border-gray);
            background: #fff;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-dark);
            text-align: center;
        }
        
        .detail-action-btn.primary {
            background: var(--court-blue);
            color: #fff;
            border-color: var(--court-blue);
        }
        
        .detail-action-btn.favorite {
            background: #fff;
            color: var(--court-blue);
            border-color: var(--court-blue);
        }
        
        .detail-action-btn:hover {
            background: #f8f9fa;
        }
        
        .detail-action-btn.primary:hover {
            background: var(--court-navy);
        }
        
        .detail-action-btn.favorite:hover {
            background: var(--court-blue);
            color: #fff;
        }
        
        /* 하단 탭 영역 */
        .tabs-section {
            background: #fff;
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            margin-top: 20px;
        }
        
        .tab-header {
            display: flex;
            border-bottom: 2px solid var(--border-gray);
            background: #f8f9fa;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-right: 1px solid var(--border-gray);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-gray);
            transition: all 0.3s;
        }
        
        .tab-button:last-child {
            border-right: none;
        }
        
        .tab-button.active {
            background: #fff;
            color: var(--court-blue);
            border-bottom: 3px solid var(--court-blue);
            margin-bottom: -2px;
        }
        
        .tab-content {
            padding: 30px;
            min-height: 300px;
        }
        
        .tab-section {
            margin-bottom: 30px;
        }
        
        .tab-section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-gray);
        }
        
        .tab-info-table {
            width: 100%;
        }
        
        .tab-info-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            padding: 10px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .tab-info-label {
            font-size: 14px;
            color: var(--text-gray);
            font-weight: 600;
        }
        
        .tab-info-value {
            font-size: 14px;
            color: var(--text-dark);
        }
        
        .appraisal-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .appraisal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .appraisal-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .appraisal-agency {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .appraisal-date {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .appraisal-amount {
            font-size: 16px;
            font-weight: 700;
            color: var(--court-blue);
        }
        
        .appraisal-download {
            padding: 8px 15px;
            background: var(--court-blue);
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
            font-size: 14px;
        }
        
        @media (max-width: 1024px) {
            .detail-main {
                grid-template-columns: 1fr;
            }
            
            .header-info {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>

<!-- =================== 헤더 =================== -->
<div th:replace="~{layout/header :: header}"></div>

<!-- =================== 메인 컨텐츠 =================== -->
<div class="detail-page-container">
    
    <!-- 상단 헤더 영역 -->
    <div class="detail-header">
        <div class="header-top">
            <div class="breadcrumb">
                <a th:href="@{/main}">홈</a> &gt; 
                <a th:href="@{/auctionList}">물건</a> &gt; 
                <span>물건검색</span>
            </div>
            <div class="share-buttons">
                <a href="#" class="share-btn" title="Facebook 공유"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="share-btn" title="Twitter 공유"><i class="fab fa-twitter"></i></a>
                <a href="#" class="share-btn" title="이메일 공유"><i class="fas fa-envelope"></i></a>
                <a href="#" class="share-btn" onclick="window.print()" title="인쇄"><i class="fas fa-print"></i></a>
            </div>
        </div>
        
        <div class="header-info" th:if="${itemHistory != null}">
            <div class="info-item">
                <span class="info-label">물건관리번호</span>
                <span class="info-value" th:text="${itemHistory.cltrMnmtNo != null ? itemHistory.cltrMnmtNo : '-'}">-</span>
            </div>
            <div class="info-item" th:if="${itemHistory.plnmNo != null}">
                <span class="info-label">공고번호</span>
                <span class="info-value" th:text="${itemHistory.plnmNo}">-</span>
            </div>
            <div class="info-item" th:if="${itemHistory.pbctNo != null}">
                <span class="info-label">공매번호</span>
                <span class="info-value" th:text="${itemHistory.pbctNo}">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">물건상태</span>
                <span class="info-value">
                    <span class="status-badge" th:text="${itemHistory.bidStatus != null ? itemHistory.bidStatus : '인터넷입찰진행중'}">인터넷입찰진행중</span>
                </span>
            </div>
        </div>
        
        <div class="notice-box">
            <div class="notice-text">
                본 물건은 일괄입찰 물건입니다. 입찰참여 전 전체 물건목록을 확인하시기 바랍니다.
            </div>
            <button class="btn-notice">일괄입찰물건 보기</button>
        </div>
    </div>
    
    <!-- 메인 컨텐츠 영역 -->
    <div class="detail-main">
        
        <!-- 왼쪽: 이미지/지도 영역 -->
        <div class="detail-left">
            <div class="item-title-section">
                <div class="item-title" th:text="${itemHistory.address != null ? itemHistory.address : '물건명'}">물건명</div>
                <div class="item-tags">
                    <span class="item-tag" th:text="${itemHistory.disposalMethod != null ? itemHistory.disposalMethod : '일반공고'}">일반공고</span>
                    <span class="item-tag">매각</span>
                    <span class="item-tag">인터넷</span>
                    <span class="item-tag" th:text="${itemHistory.assetCategory != null ? itemHistory.assetCategory : '기타일반재산'}">기타일반재산</span>
                    <span class="item-tag">일반경쟁</span>
                    <span class="item-tag">최고가방식</span>
                </div>
            </div>
            
            <div class="image-map-container">
                <!-- 부동산인 경우 지도 표시 -->
                <th:block th:if="${isRealEstate == true}">
                    <div id="map-container" style="width:100%;height:100%;position:relative;">
                        <div id="map" 
                             style="width:100%;height:100%;"
                             th:attr="data-normalized-address=${normalizedAddress != null ? normalizedAddress : ''}">
                        </div>
                        <!-- 지도 타입 전환 버튼 -->
                        <div class="map-controls">
                            <button id="map-type-btn" onclick="toggleMapType()">
                                <i class="fas fa-globe"></i> 위성사진
                            </button>
                        </div>
                    </div>
                </th:block>
                <!-- 부동산이 아닌 경우 이미지 표시 -->
                <th:block th:unless="${isRealEstate == true}">
                    <img th:src="@{/img/placeholder.svg}" alt="물건 이미지" style="width:100%;height:100%;object-fit:cover;">
                </th:block>
            </div>
            
        </div>
        
        <!-- 오른쪽: 상세 정보 -->
        <div class="detail-right">
            <table class="detail-info-table" th:if="${itemHistory != null}">
                <tr class="detail-info-row">
                    <td class="detail-info-label">처분방식/자산구분</td>
                    <td class="detail-info-value" th:text="${itemHistory.disposalMethod != null ? itemHistory.disposalMethod : '매각'} + ' / ' + (${itemHistory.assetCategory != null ? itemHistory.assetCategory : '기타일반재산'})">매각 / 기타일반재산</td>
                </tr>
                <tr class="detail-info-row">
                    <td class="detail-info-label">용도</td>
                    <td class="detail-info-value" th:text="${itemHistory.goodsDetail != null ? itemHistory.goodsDetail : '-'}">-</td>
                </tr>
                <tr class="detail-info-row">
                    <td class="detail-info-label">면적</td>
                    <td class="detail-info-value" th:text="${itemHistory.goodsDetail != null ? itemHistory.goodsDetail : '-'}">-</td>
                </tr>
                <tr class="detail-info-row">
                    <td class="detail-info-label">감정평가금액</td>
                    <td class="detail-info-value" th:text="${itemHistory.appraisalAmountMin != null ? #numbers.formatInteger(itemHistory.appraisalAmountMin, 3, 'COMMA') + '원' : '하단참조'}">하단참조</td>
                </tr>
                <tr class="detail-info-row">
                    <td class="detail-info-label">입찰방식</td>
                    <td class="detail-info-value" th:text="${itemHistory.bidMethod != null ? itemHistory.bidMethod : '일반경쟁(최고가방식) / 총액'}">일반경쟁(최고가방식) / 총액</td>
                </tr>
                <tr class="detail-info-row">
                    <td class="detail-info-label">입찰기간 (회차/차수)</td>
                    <td class="detail-info-value">
                        <span th:if="${itemHistory.bidStart != null and itemHistory.bidEnd != null}">
                            <span th:with="startYear=${#temporals.year(itemHistory.bidStart)}, endYear=${#temporals.year(itemHistory.bidEnd)}, currentYear=${T(java.time.LocalDateTime).now().year}"
                                  th:if="${startYear >= 2020 and startYear <= currentYear and endYear >= 2020 and endYear <= currentYear}"
                                  th:text="${#temporals.format(itemHistory.bidStart, 'yyyy-MM-dd HH:mm')} + ' ~ ' + ${#temporals.format(itemHistory.bidEnd, 'yyyy-MM-dd HH:mm')} + ' (1/1)'">2025-09-29 11:00 ~ 2025-12-26 16:00 (1/1)</span>
                            <span th:unless="${startYear >= 2020 and startYear <= currentYear and endYear >= 2020 and endYear <= currentYear}">-</span>
                        </span>
                        <span th:if="${itemHistory.bidStart == null or itemHistory.bidEnd == null}">-</span>
                    </td>
                </tr>
                <tr class="detail-info-row">
                    <td class="detail-info-label">유찰횟수</td>
                    <td class="detail-info-value" th:text="${itemHistory.bidCount != null ? itemHistory.bidCount : 0} + '회'">0회</td>
                </tr>
                <tr class="detail-info-row">
                    <td class="detail-info-label">집행기관</td>
                    <td class="detail-info-value" th:text="${itemHistory.orgName != null ? itemHistory.orgName : '-'}">-</td>
                </tr>
                <tr class="detail-info-row">
                    <td class="detail-info-label">담당자정보</td>
                    <td class="detail-info-value" th:text="${itemHistory.orgName != null ? itemHistory.orgName + ' / - / -' : '-'}">-</td>
                </tr>
                <tr class="detail-info-row">
                    <td class="detail-info-label">[입찰유형]</td>
                    <td class="detail-info-value">
                        <div class="bidding-types">
                            <div class="bidding-type-item">
                                <input type="checkbox" id="bid-type-1" th:checked="${itemHistory.electronicGuarantee != null ? itemHistory.electronicGuarantee : false}">
                                <label for="bid-type-1">전자보증서</label>
                            </div>
                            <div class="bidding-type-item">
                                <input type="checkbox" id="bid-type-2" th:checked="${itemHistory.jointBid != null ? itemHistory.jointBid : false}">
                                <label for="bid-type-2">공동입찰</label>
                            </div>
                            <div class="bidding-type-item">
                                <input type="checkbox" id="bid-type-3" th:checked="${itemHistory.agentBid != null ? itemHistory.agentBid : false}">
                                <label for="bid-type-3">대리입찰</label>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr class="detail-info-row">
                    <td class="detail-info-label">최저입찰가(예정가격)</td>
                    <td class="detail-info-value price" th:text="${itemHistory.minBidPriceMin != null ? #numbers.formatInteger(itemHistory.minBidPriceMin, 3, 'COMMA') + '원' : '-'}">-</td>
                </tr>
            </table>
            
            <div class="detail-actions">
                <button class="detail-action-btn favorite" 
                        id="favoriteButton"
                        th:data-item-id="${itemHistory != null ? itemHistory.plnmNo : ''}"
                        th:data-cltr-no="${itemHistory != null ? itemHistory.cltrMnmtNo : ''}"
                        onclick="return addToFavorite();">
                    <i class="far fa-star"></i> 관심물건 등록
                </button>
                <button class="detail-action-btn primary" 
                        id="bidButton"
                        th:attr="data-item-id=${itemHistory != null ? itemHistory.plnmNo : null}, 
                                 data-cltr-no=${itemHistory != null ? itemHistory.cltrMnmtNo : null}"
                        onclick="goToBidForm()">
                    입찰
                </button>
            </div>
        </div>
    </div>
    
    <!-- 하단 탭 영역 -->
    <div class="tabs-section">
        <div class="tab-header">
            <button class="tab-button active" onclick="showTab('detail')">물건 세부 정보</button>
            <button class="tab-button" onclick="showTab('bid')">입찰 정보</button>
            <button class="tab-button" onclick="showTab('stats')">시세 및 낙찰 통계</button>
        </div>
        
        <!-- 물건 세부 정보 탭 -->
        <div class="tab-content" id="tab-detail">
            <div class="tab-section">
                <div class="tab-section-title">면적 정보</div>
                <table class="tab-info-table" th:if="${itemHistory != null}">
                    <tr class="tab-info-row">
                        <td class="tab-info-label">토지면적</td>
                        <td class="tab-info-value" th:text="${itemHistory.goodsDetail != null ? itemHistory.goodsDetail : '-'}">-</td>
                    </tr>
                    <tr class="tab-info-row">
                        <td class="tab-info-label">건물면적</td>
                        <td class="tab-info-value" th:text="${itemHistory.goodsDetail != null ? itemHistory.goodsDetail : '-'}">-</td>
                    </tr>
                </table>
                <div class="no-data" th:if="${itemHistory == null}">면적 정보가 없습니다.</div>
            </div>
            
            <div class="tab-section">
                <div class="tab-section-title">위치 및 이용현황</div>
                <table class="tab-info-table" th:if="${itemHistory != null}">
                    <tr class="tab-info-row">
                        <td class="tab-info-label">소재지</td>
                        <td class="tab-info-value">
                            <div th:text="${itemHistory.nmrAddress != null ? itemHistory.nmrAddress : '-'}">-</div>
                            <div th:if="${itemHistory.roadName != null}" th:text="${itemHistory.roadName}" style="color: var(--text-gray); font-size: 12px; margin-top: 5px;">도로명주소</div>
                        </td>
                    </tr>
                    <tr class="tab-info-row">
                        <td class="tab-info-label">위치 및 부근현황</td>
                        <td class="tab-info-value" th:text="${itemHistory.nmrAddress != null ? itemHistory.nmrAddress : (itemHistory.roadName != null ? itemHistory.roadName : (itemHistory.address != null ? itemHistory.address : '-'))}">-</td>
                    </tr>
                    <tr class="tab-info-row">
                        <td class="tab-info-label">이용현황</td>
                        <td class="tab-info-value" th:text="${itemHistory.goodsDetail != null ? itemHistory.goodsDetail : '-'}">-</td>
                    </tr>
                    <tr class="tab-info-row">
                        <td class="tab-info-label">기타사항</td>
                        <td class="tab-info-value">-</td>
                    </tr>
                </table>
            </div>
            
            <div class="tab-section">
                <div class="tab-section-title">감정평가정보</div>
                <div class="appraisal-list" th:if="${itemHistory != null and itemHistory.appraisalAmountMin != null}">
                    <div class="appraisal-item">
                        <div class="appraisal-info">
                            <div class="appraisal-agency">감정평가액 평균</div>
                            <div class="appraisal-date">
                                <span th:if="${itemHistory.bidStart != null}">
                                    <span th:with="year=${#temporals.year(itemHistory.bidStart)}, currentYear=${T(java.time.LocalDateTime).now().year}"
                                          th:if="${year >= 2020 and year <= currentYear}">
                                        평가일: <span th:text="${#temporals.format(itemHistory.bidStart, 'yyyy-MM-dd')}"></span>
                                    </span>
                                    <span th:unless="${year >= 2020 and year <= currentYear}">평가일: -</span>
                                </span>
                                <span th:if="${itemHistory.bidStart == null}">평가일: -</span>
                            </div>
                        </div>
                        <div class="appraisal-amount" th:text="${#numbers.formatInteger(itemHistory.appraisalAmountMin, 3, 'COMMA') + '원'}">-</div>
                        <button class="appraisal-download">감정평가서</button>
                    </div>
                </div>
                <div class="no-data" th:if="${itemHistory == null or itemHistory.appraisalAmountMin == null}">감정평가 정보가 없습니다.</div>
            </div>
            
            <div class="tab-section">
                <div class="tab-section-title">낙찰 후 인도/인수 책임 및 부대조건</div>
                <table class="tab-info-table">
                    <tr class="tab-info-row">
                        <td class="tab-info-label">인도/인수 책임</td>
                        <td class="tab-info-value">낙찰자</td>
                    </tr>
                    <tr class="tab-info-row">
                        <td class="tab-info-label">부대조건</td>
                        <td class="tab-info-value">-</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <!-- 입찰 정보 탭 -->
        <div class="tab-content" id="tab-bid" style="display: none;">
            <div class="no-data">입찰 정보가 없습니다.</div>
        </div>
        
        <!-- 시세 및 낙찰 통계 탭 -->
        <div class="tab-content" id="tab-stats" style="display: none;">
            <div class="no-data">시세 및 낙찰 통계 정보가 없습니다.</div>
        </div>
        
        <!-- 주변정보 탭 -->
        <div class="tab-content" id="tab-surrounding" style="display: none;">
            <div class="no-data">주변정보가 없습니다.</div>
        </div>
        
        <!-- 부가정보 탭 -->
        <div class="tab-content" id="tab-additional" style="display: none;">
            <div class="no-data">부가정보가 없습니다.</div>
        </div>
        
        <!-- 일괄입찰물건 탭 -->
        <div class="tab-content" id="tab-batch" style="display: none;">
            <div class="no-data">일괄입찰물건 목록이 없습니다.</div>
        </div>
    </div>
    
</div>

<!-- =================== 푸터 =================== -->
<div th:replace="~{layout/footer :: footer}"></div>

<!-- JavaScript -->
<script>
    // 탭 전환
    function showTab(tabName) {
        // 모든 탭 버튼 비활성화
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // 모든 탭 컨텐츠 숨기기
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
        });
        
        // 선택된 탭 버튼 활성화
        event.target.classList.add('active');
        document.getElementById('tab-' + tabName).style.display = 'block';
    }
    
    // 입찰서 작성 페이지로 이동
    function goToBidForm() {
        console.log('입찰 버튼 클릭됨 - 입찰서 작성 페이지로 이동');
        
        try {
            // 버튼에서 data 속성으로 정보 가져오기
            const bidButton = document.getElementById('bidButton');
            if (!bidButton) {
                console.error('입찰 버튼을 찾을 수 없습니다.');
                alert('입찰 버튼을 찾을 수 없습니다.');
                return;
            }
            
            const itemId = bidButton.getAttribute('data-item-id');
            const cltrNo = bidButton.getAttribute('data-cltr-no');
            
            console.log('itemId:', itemId, 'cltrNo:', cltrNo);
            
            // itemId나 cltrNo가 없으면 URL 파라미터에서 가져오기
            if ((!itemId || itemId === 'null' || itemId === '') && (!cltrNo || cltrNo === 'null' || cltrNo === '')) {
                const urlParams = new URLSearchParams(window.location.search);
                const urlItemId = urlParams.get('itemId');
                const urlCltrNo = urlParams.get('cltrNo');
                if (urlItemId) {
                    const bidFormUrl = '/payment/bid-form?itemId=' + encodeURIComponent(urlItemId);
                    console.log('입찰서 작성 페이지로 이동 (URL 파라미터 사용):', bidFormUrl);
                    window.location.href = bidFormUrl;
                    return;
                } else if (urlCltrNo) {
                    const bidFormUrl = '/payment/bid-form?cltrNo=' + encodeURIComponent(urlCltrNo);
                    console.log('입찰서 작성 페이지로 이동 (URL 파라미터 사용):', bidFormUrl);
                    window.location.href = bidFormUrl;
                    return;
                }
                alert('물건 정보를 찾을 수 없습니다.');
                return;
            }
            
            // itemId가 있으면 itemId 사용, 없으면 cltrNo 사용
            let bidFormUrl = '';
            if (itemId && itemId !== 'null' && itemId !== '') {
                bidFormUrl = '/payment/bid-form?itemId=' + itemId;
            } else if (cltrNo && cltrNo !== 'null' && cltrNo !== '') {
                bidFormUrl = '/payment/bid-form?cltrNo=' + encodeURIComponent(cltrNo);
            } else {
                alert('물건 정보를 찾을 수 없습니다.');
                return;
            }
            
            console.log('입찰서 작성 페이지로 이동:', bidFormUrl);
            window.location.href = bidFormUrl;
        } catch (error) {
            console.error('입찰서 작성 페이지 이동 중 오류:', error);
            alert('입찰서 작성 페이지로 이동하는 중 오류가 발생했습니다: ' + error.message);
        }
    }
    
    // 즐겨찾기 추가 함수 (완전히 새로 작성)
    function addToFavorite() {
        console.log('========================================');
        console.log('=== 즐겨찾기 추가 함수 호출됨 ===');
        console.log('========================================');
        
        // 즉시 확인: 함수가 호출되는지
        if (!window.confirm('즐겨찾기에 추가하시겠습니까?')) {
            return false;
        }
        
        try {
            // jQuery 확인
            if (typeof $ === 'undefined' && typeof jQuery === 'undefined') {
                alert('jQuery가 로드되지 않았습니다.');
                return false;
            }
            const $ = window.jQuery || window.$;
            
            // 버튼 찾기
            const btn = document.getElementById('favoriteButton');
            if (!btn) {
                alert('버튼을 찾을 수 없습니다.');
                return false;
            }
            
            // 모든 방법으로 값 가져오기
            let itemId = btn.getAttribute('data-item-id') || 
                        btn.dataset.itemId || 
                        btn.getAttribute('data-itemId') ||
                        null;
            let cltrNo = btn.getAttribute('data-cltr-no') || 
                        btn.dataset.cltrNo || 
                        btn.getAttribute('data-cltrNo') ||
                        null;
            
            // URL에서도 가져오기
            const urlParams = new URLSearchParams(window.location.search);
            if (!itemId) itemId = urlParams.get('itemId');
            if (!cltrNo) cltrNo = urlParams.get('cltrNo');
            
            // null 문자열 처리
            if (itemId === 'null' || itemId === '') itemId = null;
            if (cltrNo === 'null' || cltrNo === '') cltrNo = null;
            
            console.log('itemId:', itemId, 'cltrNo:', cltrNo);
            
            // 요청 데이터 구성
            const data = {};
            if (itemId) {
                const id = parseInt(itemId);
                if (!isNaN(id) && id > 0) {
                    data.itemId = id;
                }
            }
            if (cltrNo) {
                data.cltrNo = cltrNo.toString().trim();
            }
            
            if (!data.itemId && !data.cltrNo) {
                alert('물건 정보를 찾을 수 없습니다.\nitemId: ' + itemId + '\ncltrNo: ' + cltrNo);
                return false;
            }
            
            console.log('요청 데이터:', data);
            
            // AJAX 요청
            $.ajax({
                url: '/api/favorites',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(res) {
                    console.log('응답:', res);
                    if (res && res.success) {
                        alert('✅ 관심물건으로 등록되었습니다!');
                        if (btn) {
                            btn.innerHTML = '<i class="fas fa-star"></i> 관심물건 해제';
                            btn.onclick = function() { removeFavorite(); return false; };
                        }
                    } else {
                        alert('등록 실패: ' + (res && res.message ? res.message : '알 수 없는 오류'));
                    }
                },
                error: function(xhr) {
                    console.error('오류:', xhr);
                    let msg = '오류가 발생했습니다.';
                    if (xhr.status === 401 || xhr.status === 403) {
                        msg = '로그인이 필요합니다.';
                        window.location.href = '/memberLogin';
                        return;
                    } else if (xhr.responseJSON && xhr.responseJSON.message) {
                        msg = xhr.responseJSON.message;
                    }
                    alert('❌ ' + msg);
                }
            });
            
            return false;
        } catch (e) {
            console.error('예외:', e);
            alert('오류: ' + e.message);
            return false;
        }
    }
    
    // 즐겨찾기 해제
    function removeFavorite() {
        console.log('즐겨찾기 해제 함수 호출됨');
        
        // 버튼의 data 속성에서 cltrNo 또는 itemId 가져오기
        const favoriteButton = document.getElementById('favoriteButton');
        let cltrNo = null;
        let itemId = null;
        
        if (favoriteButton) {
            cltrNo = favoriteButton.getAttribute('data-cltr-no');
            itemId = favoriteButton.getAttribute('data-item-id');
        }
        
        // URL 파라미터에서도 확인 (fallback)
        if (!cltrNo && !itemId) {
            const urlParams = new URLSearchParams(window.location.search);
            cltrNo = urlParams.get('cltrNo');
            const urlItemId = urlParams.get('itemId');
            if (urlItemId) {
                itemId = urlItemId;
            }
        }
        
        if (!cltrNo && !itemId) {
            alert('물건 정보를 찾을 수 없습니다.');
            return;
        }
        
        // 즐겨찾기 확인 요청
        let checkUrl = '/api/favorites/check?';
        if (itemId && itemId !== 'null' && itemId !== '') {
            checkUrl += 'itemId=' + itemId;
        } else if (cltrNo && cltrNo !== 'null' && cltrNo !== '') {
            checkUrl += 'cltrNo=' + encodeURIComponent(cltrNo);
        }
        
        console.log('즐겨찾기 확인 URL:', checkUrl);
        
        $.ajax({
            url: checkUrl,
            method: 'GET',
            success: function(response) {
                console.log('즐겨찾기 확인 응답:', response);
                if (response.success && response.favoriteId) {
                    $.ajax({
                        url: '/api/favorites/' + response.favoriteId,
                        method: 'DELETE',
                        success: function(deleteResponse) {
                            console.log('즐겨찾기 삭제 응답:', deleteResponse);
                            if (deleteResponse.success) {
                                alert('관심물건에서 해제되었습니다.');
                                const btn = document.getElementById('favoriteButton');
                                if (btn) {
                                    btn.innerHTML = '<i class="far fa-star"></i> 관심물건 등록';
                                    btn.onclick = function() { addToFavorite(); };
                                }
                            } else {
                                alert('관심물건 해제에 실패했습니다.');
                            }
                        },
                        error: function(xhr) {
                            console.error('즐겨찾기 삭제 오류:', xhr);
                            alert('관심물건 해제 중 오류가 발생했습니다.');
                        }
                    });
                } else {
                    alert('관심물건 정보를 찾을 수 없습니다.');
                }
            },
            error: function(xhr) {
                console.error('즐겨찾기 확인 오류:', xhr);
                alert('관심물건 확인 중 오류가 발생했습니다.');
            }
        });
    }
</script>

<!-- 지도 초기화 (부동산인 경우) - 메인화면 방식 참고 -->
<th:block th:if="${isRealEstate == true}">
<script>
    (function() {
        let mapIframe;
        let currentMapType = 'satellite'; // 'satellite' or 'street'
        let searchAddress = ''; // 현재 검색 주소 저장
        
        // 주소 선택 함수 (서버에서 계산된 normalizedAddress 사용)
        function getSearchAddress() {
            const mapContainer = document.getElementById('map');
            if (!mapContainer) {
                return '서울특별시 중구 세종대로 110';
            }
            
            // 서버에서 계산된 정규화된 주소 사용
            const normalizedAddress = mapContainer.getAttribute('data-normalized-address') || '';
            
            if (normalizedAddress && normalizedAddress.trim() !== '') {
                return normalizedAddress.trim();
            }
            
            // 기본값
            return '서울특별시 중구 세종대로 110';
        }
        
        function initMap() {
            const mapContainer = document.getElementById('map');
            if (!mapContainer) {
                console.log('지도 컨테이너를 찾을 수 없습니다.');
                return;
            }
            
            searchAddress = getSearchAddress();
            console.log('지도 검색 주소:', searchAddress);
            
            // Google Maps iframe 생성 (메인화면 방식)
            mapIframe = document.createElement('iframe');
            mapIframe.setAttribute('loading', 'lazy');
            mapIframe.setAttribute('referrerpolicy', 'no-referrer-when-downgrade');
            mapIframe.style.width = '100%';
            mapIframe.style.height = '140%';
            mapIframe.style.border = '0';
            mapIframe.src = `https://maps.google.com/maps?q=${encodeURIComponent(searchAddress)}&output=embed&t=k&z=19`;
            
            // 기존 내용 제거 후 iframe 추가
            mapContainer.innerHTML = '';
            mapContainer.appendChild(mapIframe);
        }
        
        // 지도 타입 전환 (일반지도 <-> 위성사진)
        window.toggleMapType = function() {
            if (!mapIframe) {
                initMap();
                return;
            }
            
            const btn = document.getElementById('map-type-btn');
            if (!btn) return;
            
            // 주소 다시 가져오기 (페이지가 동적으로 변경될 수 있으므로)
            searchAddress = getSearchAddress();
            
            if (currentMapType === 'satellite') {
                // 일반지도로 전환 (t=m: 일반지도)
                mapIframe.src = `https://maps.google.com/maps?q=${encodeURIComponent(searchAddress)}&output=embed&t=m&z=19`;
                currentMapType = 'street';
                btn.innerHTML = '<i class="fas fa-globe"></i> 위성사진';
            } else {
                // 위성사진으로 전환 (t=k: 위성지도)
                mapIframe.src = `https://maps.google.com/maps?q=${encodeURIComponent(searchAddress)}&output=embed&t=k&z=19`;
                currentMapType = 'satellite';
                btn.innerHTML = '<i class="fas fa-map"></i> 일반지도';
            }
        };
        
        // 페이지 로드 후 지도 초기화
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initMap, 100);
        });
    })();
</script>
</th:block>

</body>
</html>
